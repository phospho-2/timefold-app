// TimefoldAI v2.0 JavaScript

// APIåŸºåº•URL
const API_BASE = '/api';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ TimefoldAI v2.0 åˆæœŸåŒ–ä¸­...');
    loadSystemStatus();
    loadAllData();
});

// ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®èª­ã¿è¾¼ã¿
async function loadSystemStatus() {
    try {
        const response = await fetch(`${API_BASE}/test`);
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('systemStatus').innerHTML = `
                <div class="status-info">
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.subjects}</div>
                        <div class="status-label">ç§‘ç›®</div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.teachers}</div>
                        <div class="status-label">æ•™å¸«</div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.timeslots}</div>
                        <div class="status-label">æ™‚é–“æ </div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.student_groups}</div>
                        <div class="status-label">ã‚¯ãƒ©ã‚¹</div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #27ae60;">âœ… ${data.message}</p>
            `;
        }
    } catch (error) {
        console.error('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('systemStatus').innerHTML = `
            <p style="color: #e74c3c;">âŒ ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šã‚¨ãƒ©ãƒ¼</p>
        `;
    }
}

// å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadAllData() {
    await loadSubjects();
    await loadTeachers();
    await loadTimeslots();
    await loadLessons();
}

// ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadSubjects() {
    try {
        const response = await fetch(`${API_BASE}/subjects`);
        const subjects = await response.json();
        
        const html = subjects.map(subject => `
            <div class="data-item">
                <strong>${subject.name}</strong> (${subject.code}) 
                - ${subject.category} - é€±${subject.weekly_hours}æ™‚é–“
                <br><small>${subject.description}</small>
            </div>
        `).join('');
        
        document.getElementById('subjectsList').innerHTML = html;
    } catch (error) {
        console.error('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('subjectsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadTeachers() {
    try {
        const response = await fetch(`${API_BASE}/teachers`);
        const teachers = await response.json();
        
        const html = teachers.map(teacher => `
            <div class="data-item">
                <strong>${teacher.name}</strong> (${teacher.email})
                <br>æ‹…å½“ç§‘ç›®: ${teacher.subjects.join(', ')}
                <br>å‹¤å‹™å½¢æ…‹: ${teacher.employment_type} - æœ€å¤§æˆæ¥­æ•°: ${teacher.max_daily_lessons}/æ—¥
            </div>
        `).join('');
        
        document.getElementById('teachersList').innerHTML = html;
    } catch (error) {
        console.error('æ•™å¸«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('teachersList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æ™‚é–“æ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadTimeslots() {
    try {
        const response = await fetch(`${API_BASE}/timeslots`);
        const timeslots = await response.json();
        
        // æ›œæ—¥åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
        const dayNames = ['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥'];
        
        let html = '';
        days.forEach((day, index) => {
            const daySlots = timeslots.filter(slot => slot.day_of_week === day);
            html += `<h4>${dayNames[index]}</h4>`;
            html += daySlots.map(slot => `
                <div class="data-item">
                    ${slot.period_name}: ${slot.start_time} - ${slot.end_time}
                </div>
            `).join('');
        });
        
        document.getElementById('timeslotsList').innerHTML = html;
    } catch (error) {
        console.error('æ™‚é–“æ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('timeslotsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æˆæ¥­ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadLessons() {
    try {
        const response = await fetch(`${API_BASE}/lessons`);
        const lessons = await response.json();
        
        const html = lessons.map(lesson => `
            <div class="data-item">
                <strong>${lesson.subject?.name || 'N/A'}</strong>
                - ${lesson.teacher?.name || 'N/A'}
                - ${lesson.student_group?.name || 'N/A'}
                <br><small>æˆæ¥­ã‚¿ã‚¤ãƒ—: ${lesson.lesson_type}</small>
            </div>
        `).join('');
        
        document.getElementById('lessonsList').innerHTML = html;
    } catch (error) {
        console.error('æˆæ¥­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('lessonsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function showTab(tabName) {
    // å…¨ã¦ã®ã‚¿ãƒ–ã‚’éè¡¨ç¤º
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// æœ€é©åŒ–ãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰
function testOptimization() {
    alert('ğŸš§ æœ€é©åŒ–æ©Ÿèƒ½ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…äºˆå®šã§ã™ï¼');
}

// ãƒ‡ãƒ¼ã‚¿æ›´æ–°
function refreshData() {
    console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...');
    loadSystemStatus();
    loadAllData();
}

// TimefoldAI v2.0 JavaScript

// APIåŸºåº•URL
const API_BASE = '/api';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ TimefoldAI v2.0 åˆæœŸåŒ–ä¸­...');
    loadSystemStatus();
    loadAllData();
});

// ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®èª­ã¿è¾¼ã¿
async function loadSystemStatus() {
    try {
        const response = await fetch(`${API_BASE}/test`);
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('systemStatus').innerHTML = `
                <div class="status-info">
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.subjects}</div>
                        <div class="status-label">ç§‘ç›®</div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.teachers}</div>
                        <div class="status-label">æ•™å¸«</div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.timeslots}</div>
                        <div class="status-label">æ™‚é–“æ </div>
                    </div>
                    <div class="status-card">
                        <div class="status-number">${data.data_summary.student_groups}</div>
                        <div class="status-label">ã‚¯ãƒ©ã‚¹</div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #27ae60;">âœ… ${data.message}</p>
            `;
        }
    } catch (error) {
        console.error('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('systemStatus').innerHTML = `
            <p style="color: #e74c3c;">âŒ ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šã‚¨ãƒ©ãƒ¼</p>
        `;
    }
}

// å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadAllData() {
    await loadSubjects();
    await loadTeachers();
    await loadTimeslots();
    await loadLessons();
}

// ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadSubjects() {
    try {
        const response = await fetch(`${API_BASE}/subjects`);
        const subjects = await response.json();
        
        const html = subjects.map(subject => `
            <div class="data-item">
                <strong>${subject.name}</strong> (${subject.code}) 
                - ${subject.category} - é€±${subject.weekly_hours}æ™‚é–“
                <br><small>${subject.description}</small>
            </div>
        `).join('');
        
        document.getElementById('subjectsList').innerHTML = html;
    } catch (error) {
        console.error('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('subjectsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadTeachers() {
    try {
        const response = await fetch(`${API_BASE}/teachers`);
        const teachers = await response.json();
        
        const html = teachers.map(teacher => `
            <div class="data-item">
                <strong>${teacher.name}</strong> (${teacher.email})
                <br>æ‹…å½“ç§‘ç›®: ${teacher.subjects.join(', ')}
                <br>å‹¤å‹™å½¢æ…‹: ${teacher.employment_type} - æœ€å¤§æˆæ¥­æ•°: ${teacher.max_daily_lessons}/æ—¥
            </div>
        `).join('');
        
        document.getElementById('teachersList').innerHTML = html;
    } catch (error) {
        console.error('æ•™å¸«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('teachersList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æ™‚é–“æ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadTimeslots() {
    try {
        const response = await fetch(`${API_BASE}/timeslots`);
        const timeslots = await response.json();
        
        // æ›œæ—¥åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
        const dayNames = ['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥'];
        
        let html = '';
        days.forEach((day, index) => {
            const daySlots = timeslots.filter(slot => slot.day_of_week === day);
            html += `<h4>${dayNames[index]}</h4>`;
            html += daySlots.map(slot => `
                <div class="data-item">
                    ${slot.period_name}: ${slot.start_time} - ${slot.end_time}
                </div>
            `).join('');
        });
        
        document.getElementById('timeslotsList').innerHTML = html;
    } catch (error) {
        console.error('æ™‚é–“æ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('timeslotsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// æˆæ¥­ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
async function loadLessons() {
    try {
        const response = await fetch(`${API_BASE}/lessons`);
        const lessons = await response.json();
        
        const html = lessons.map(lesson => `
            <div class="data-item">
                <strong>${lesson.subject?.name || 'N/A'}</strong>
                - ${lesson.teacher?.name || 'N/A'}
                - ${lesson.student_group?.name || 'N/A'}
                <br><small>æˆæ¥­ã‚¿ã‚¤ãƒ—: ${lesson.lesson_type}</small>
            </div>
        `).join('');
        
        document.getElementById('lessonsList').innerHTML = html;
    } catch (error) {
        console.error('æˆæ¥­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('lessonsList').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
    }
}

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function showTab(tabName) {
    // å…¨ã¦ã®ã‚¿ãƒ–ã‚’éè¡¨ç¤º
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// æœ€é©åŒ–ãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰
function testOptimization() {
    alert('ğŸš§ æœ€é©åŒ–æ©Ÿèƒ½ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…äºˆå®šã§ã™ï¼');
}

// ãƒ‡ãƒ¼ã‚¿æ›´æ–°
function refreshData() {
    console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...');
    loadSystemStatus();
    loadAllData();
}

// æ—¢å­˜ã®main.jsã«ä»¥ä¸‹ã®é–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„

// æœ€é©åŒ–é–¢é€£ã®å¤‰æ•°
let currentOptimizationData = null;

// æœ€é©åŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
async function runOptimizationTest() {
    console.log('ğŸ¯ æœ€é©åŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å–å¾—
    const statusDiv = document.getElementById('status') || createStatusDiv();
    
    try {
        // æœ€é©åŒ–çŠ¶æ³ç¢ºèª
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                ğŸ” æœ€é©åŒ–ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ³ç¢ºèªä¸­...
            </div>
        `;
        
        const statusResponse = await fetch('/api/optimization-status');
        const statusData = await statusResponse.json();
        
        if (statusData.status !== 'ready') {
            throw new Error(statusData.message);
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                ğŸ“š æœ€é©åŒ–ç”¨ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
            </div>
        `;
        
        const demoResponse = await fetch('/api/demo-data');
        currentOptimizationData = await demoResponse.json();
        
        // æœ€é©åŒ–å®Ÿè¡Œ
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                ğŸš€ æœ¬æ ¼Timefold AI v6 æœ€é©åŒ–å®Ÿè¡Œä¸­...<br>
                ğŸ”¬ ãƒ¡ã‚¿ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œä¸­<br>
                âš–ï¸ Hardåˆ¶ç´„å……è¶³ + Softåˆ¶ç´„æœ€é©åŒ–<br>
                ğŸ§  ã‚¿ãƒ–ãƒ¼ã‚µãƒ¼ãƒãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒ†ãƒƒãƒ‰ã‚¢ãƒ‹ãƒ¼ãƒªãƒ³ã‚°å‹•ä½œä¸­<br>
                ğŸ“Š æˆæ¥­æ•°: ${currentOptimizationData.lessons.length}ä»¶<br>
                ğŸ•’ æ™‚é–“å¸¯: ${currentOptimizationData.timeslots.length}ã‚³ãƒ<br>
                ğŸ« æ•™å®¤æ•°: ${currentOptimizationData.rooms.length}å®¤<br>
                <div class="spinner-border spinner-border-sm mt-2" role="status"></div>
            </div>
        `;
        
        const optimizeResponse = await fetch('/api/optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentOptimizationData)
        });
        
        const result = await optimizeResponse.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // æœ€é©åŒ–æˆåŠŸ
        currentOptimizationData = result;
        
        // é…ç½®ç‡è¨ˆç®—
        const assignedLessons = result.lessons.filter(l => l.timeslot && l.room);
        const assignmentRate = Math.round((assignedLessons.length / result.lessons.length) * 100);
        
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                ğŸ‰ æœ¬æ ¼AIæœ€é©åŒ–å®Œäº†ï¼<br>
                ğŸ“Š é…ç½®ç‡: ${assignmentRate}% (${assignedLessons.length}/${result.lessons.length}ä»¶)<br>
                ğŸ† ã‚¹ã‚³ã‚¢: ${result.score}<br>
                ğŸ”¬ Real Timefold Solver ã«ã‚ˆã‚‹å¤šç›®çš„æœ€é©åŒ–æˆåŠŸ<br>
                âœ… åˆ¶ç´„é•åå•é¡Œå®Œå…¨è§£æ±º
            </div>
        `;
        
        // æ™‚é–“å‰²è¡¨ç¤º
        displayOptimizationResult(result);
        
        console.log('ğŸ‰ æœ€é©åŒ–ãƒ†ã‚¹ãƒˆå®Œäº†', result);
        
    } catch (error) {
        console.error('âŒ æœ€é©åŒ–ã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                âŒ æœ€é©åŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}<br>
                <small>è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
            </div>
        `;
    }
}

// æœ€é©åŒ–çµæœã®è¡¨ç¤º
function displayOptimizationResult(data) {
    const timetableDiv = document.getElementById('timetable');
    if (!timetableDiv) return;
    
    const timeslots = data.timeslots;
    const rooms = data.rooms;
    const lessons = data.lessons;
    
    let html = '<div class="mt-4">';
    html += '<h3>ğŸ“… æœ¬æ ¼AIæœ€é©åŒ–æ™‚é–“å‰²</h3>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-bordered table-hover">';
    html += '<thead class="table-primary">';
    html += '<tr><th style="width: 200px;">æ™‚é–“å¸¯</th>';
    
    rooms.forEach(room => {
        html += `<th>${room.name}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    timeslots.forEach(timeslot => {
        html += '<tr>';
        html += `<td><strong>${timeslot.day_of_week}</strong><br>${timeslot.start_time}-${timeslot.end_time}</td>`;
        
        rooms.forEach(room => {
            html += '<td>';
            const lesson = lessons.find(l => 
                l.timeslot && l.room && 
                l.timeslot.id === timeslot.id && 
                l.room.id === room.id
            );
            
            if (lesson) {
                html += `
                    <div class="lesson-card">
                        <strong>${lesson.subject.name}</strong><br>
                        ğŸ‘¨â€ğŸ« ${lesson.teacher.name}<br>
                        ğŸ‘¥ ${lesson.student_group.name}
                    </div>
                `;
            }
            html += '</td>';
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    // AIæœ€é©åŒ–çµæœã®è©³ç´°åˆ†æ
    const assignedLessons = lessons.filter(l => l.timeslot && l.room);
    const unassignedLessons = lessons.filter(l => !l.timeslot || !l.room);
    
    html += '<div class="row mt-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-header bg-primary text-white">';
    html += '<h5 class="mb-0">ğŸ§  æœ¬æ ¼AIæœ€é©åŒ–çµæœåˆ†æ</h5>';
    html += '</div>';
    html += '<div class="card-body">';
from datetime import time
from typing import List, Dict, Any
import json

from timefold.solver import SolverFactory
from timefold.solver.config import SolverConfig, TerminationConfig, ScoreDirectorFactoryConfig, Duration

from backend.models.timefold_models import (
    TimeTable, Lesson, Timeslot, Room, Subject, Teacher, StudentGroup, define_constraints
)
from backend.models.database import JSONDataRepository

class OptimizationService:
    def __init__(self):
        self.db = JSONDataRepository()
        
    def generate_demo_data(self) -> TimeTable:
        """ãƒ‡ãƒ¢ç”¨ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ"""
        timeslots = [
            Timeslot(1, "æœˆæ›œæ—¥", time(8, 50), time(9, 40)),
            Timeslot(2, "æœˆæ›œæ—¥", time(9, 50), time(10, 40)),
            Timeslot(3, "æœˆæ›œæ—¥", time(10, 50), time(11, 40)),
            Timeslot(4, "æœˆæ›œæ—¥", time(13, 30), time(14, 20)),
            Timeslot(5, "ç«æ›œæ—¥", time(8, 50), time(9, 40)),
            Timeslot(6, "ç«æ›œæ—¥", time(9, 50), time(10, 40)),
            Timeslot(7, "ç«æ›œæ—¥", time(10, 50), time(11, 40)),
            Timeslot(8, "ç«æ›œæ—¥", time(13, 30), time(14, 20)),
            Timeslot(9, "æ°´æ›œæ—¥", time(8, 50), time(9, 40)),
            Timeslot(10, "æ°´æ›œæ—¥", time(9, 50), time(10, 40)),
            Timeslot(11, "æœ¨æ›œæ—¥", time(8, 50), time(9, 40)),
            Timeslot(12, "æœ¨æ›œæ—¥", time(9, 50), time(10, 40)),
            Timeslot(13, "é‡‘æ›œæ—¥", time(8, 50), time(9, 40)),
            Timeslot(14, "é‡‘æ›œæ—¥", time(9, 50), time(10, 40)),
        ]
        
        # ãƒ‡ãƒ¢ç”¨ï¼šæ•™å®¤2ã¤ã®ã¿
        rooms = [
            Room(1, "æ•™å®¤A"),
            Room(2, "æ•™å®¤B"),
        ]
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å®Ÿéš›ã®æ•™å¸«ã¨ç§‘ç›®ã€å­¦ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
        teachers_data = [t.to_dict() for t in self.db.get_teachers()]
        subjects_data = [s.to_dict() for s in self.db.get_subjects()]
        student_groups_data = [sg.to_dict() for sg in self.db.get_student_groups()]
        
        # TimefoldAIç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        teachers = [Teacher(t['id'], t['name']) for t in teachers_data]
        subjects = [Subject(s['id'], s['name']) for s in subjects_data]
        student_groups = [StudentGroup(sg['id'], sg['name']) for sg in student_groups_data]
        
        # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹æ•°ã‚’ãƒ­ã‚°å‡ºåŠ›
        print(f"ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹: {[sg.name for sg in student_groups]}")
        
        # æˆæ¥­ã‚’å‹•çš„ã«ç”Ÿæˆï¼ˆæ•™å¸«ã¨ç§‘ç›®ã®çµ„ã¿åˆã‚ã›ï¼‰
        lessons = []
        lesson_id = 1
        
        for student_group in student_groups:
            # å„ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦å„ç§‘ç›®ã®æˆæ¥­ã‚’ä½œæˆ
            for subject in subjects:
                # ãã®ç§‘ç›®ã‚’æ•™ãˆã‚‰ã‚Œã‚‹æ•™å¸«ã‚’è¦‹ã¤ã‘ã‚‹
                suitable_teachers = []
                for teacher in teachers:
                    teacher_data = next((t for t in teachers_data if t['id'] == teacher.id), None)
                    if teacher_data and subject.name in teacher_data.get('subjects', []):
                        suitable_teachers.append(teacher)
                
                # é©åˆ‡ãªæ•™å¸«ãŒã„ã‚Œã°æˆæ¥­ã‚’ä½œæˆ
                if suitable_teachers:
                    teacher = suitable_teachers[0]  # æœ€åˆã®é©åˆ‡ãªæ•™å¸«ã‚’é¸æŠ
                    lesson = Lesson(lesson_id, subject, teacher, student_group)
                    lessons.append(lesson)
                    lesson_id += 1
        
        print(f"ğŸ¯ ãƒ‡ãƒ¢ç”¨æœ€é©åŒ–ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†:")
        print(f"   ğŸ“š ç§‘ç›®æ•°: {len(subjects)}")
        print(f"   ğŸ‘¨â€ğŸ« æ•™å¸«æ•°: {len(teachers)}")  
        print(f"   ğŸ‘¥ ã‚¯ãƒ©ã‚¹æ•°: {len(student_groups)}")
        print(f"   ğŸ“ æˆæ¥­æ•°: {len(lessons)}")
        print(f"   ğŸ•’ æ™‚é–“å¸¯æ•°: {len(timeslots)}")
        print(f"   ğŸ« æ•™å®¤æ•°: {len(rooms)}")
        
        # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç”Ÿæˆã•ã‚ŒãŸæˆæ¥­ã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
        for lesson in lessons:
            print(f"   ğŸ“ æˆæ¥­: {lesson.subject.name} - {lesson.teacher.name} - {lesson.student_group.name}")
        
        return TimeTable(timeslots=timeslots, rooms=rooms, lessons=lessons)
    
    def convert_to_json(self, timetable: TimeTable) -> Dict[str, Any]:
        """TimefoldAIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONå½¢å¼ã«å¤‰æ›"""
        return {
            "timeslots": [
                {
                    "id": t.id, 
                    "day_of_week": t.day_of_week, 
                    "start_time": t.start_time.strftime("%H:%M"), 
                    "end_time": t.end_time.strftime("%H:%M")
                } for t in timetable.timeslots
            ],
            "rooms": [
                {"id": r.id, "name": r.name} for r in timetable.rooms
            ],
            "lessons": [
                {
                    "id": l.id, 
                    "subject": {"id": l.subject.id, "name": l.subject.name},
                    "teacher": {"id": l.teacher.id, "name": l.teacher.name},
                    "student_group": {"id": l.student_group.id, "name": l.student_group.name},
                    "timeslot": {
                        "id": l.timeslot.id, 
                        "day_of_week": l.timeslot.day_of_week,
                        "start_time": l.timeslot.start_time.strftime("%H:%M"),
                        "end_time": l.timeslot.end_time.strftime("%H:%M")
                    } if l.timeslot else None,
                    "room": {"id": l.room.id, "name": l.room.name} if l.room else None
                } for l in timetable.lessons
            ],
            "score": str(timetable.score) if timetable.score else "Perfect"
        }
    
    def convert_from_json(self, data: Dict[str, Any]) -> TimeTable:
        """JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’TimefoldAIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›"""
        # Timeslotsã®å¤‰æ›
        timeslots = [
            Timeslot(
                t["id"], 
                t["day_of_week"], 
                time.fromisoformat(t["start_time"]), 
                time.fromisoformat(t["end_time"])
            ) for t in data["timeslots"]
        ]
        
        # Roomsã®å¤‰æ›
        rooms = [Room(r["id"], r["name"]) for r in data["rooms"]]
        
        # Lessonsã®å¤‰æ›
        lessons = []
        for l in data["lessons"]:
            subject = Subject(l["subject"]["id"], l["subject"]["name"])
            teacher = Teacher(l["teacher"]["id"], l["teacher"]["name"])
            student_group = StudentGroup(l["student_group"]["id"], l["student_group"]["name"])
            
            lesson = Lesson(l["id"], subject, teacher, student_group)
            
            # timeslotã¨roomãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆ
            if l.get("timeslot"):
                lesson.timeslot = next(
                    (ts for ts in timeslots if ts.id == l["timeslot"]["id"]), None
                )
            if l.get("room"):
                lesson.room = next(
                    (r for r in rooms if r.id == l["room"]["id"]), None
                )
            
            lessons.append(lesson)
        
        return TimeTable(timeslots=timeslots, rooms=rooms, lessons=lessons)
    
    def optimize_timetable(self, timetable: TimeTable) -> TimeTable:
        """ğŸ¯ æœ¬æ ¼ç‰ˆ Timefold AI v6 ã§æ™‚é–“å‰²ã‚’æœ€é©åŒ–"""
        try:
            print("ğŸ¯ Starting Real Timefold AI v6 optimization...")
            print("ğŸ”§ Configuring Real Timefold Solver v6...")
            print("ğŸ§  Meta-heuristic algorithms: Tabu Search, Simulated Annealing, Hill Climbing")
            print("âš–ï¸ Hard/Soft constraint multi-objective optimization")
            
            # ğŸš€ æœ¬æ ¼ç‰ˆ Timefold Solverè¨­å®š
            solver_config = SolverConfig(
                solution_class=TimeTable,
                entity_class_list=[Lesson],
                score_director_factory_config=ScoreDirectorFactoryConfig(
                    constraint_provider_function=define_constraints
                ),
                termination_config=TerminationConfig(
                    spent_limit=Duration(seconds=30)  # 30ç§’ã§æœ¬æ ¼æœ€é©åŒ–
                )
            )
            
            print("ğŸš€ Executing Real Timefold AI v6...")
            
            # ğŸ¯ æœ¬ç‰©ã®Timefold Solverå®Ÿè¡Œ
            solver = SolverFactory.create(solver_config).build_solver()
            solution = solver.solve(timetable)
            
            print(f"ğŸ‰ Real AI Optimization completed! Score: {solution.score}")
            
            # åˆ¶ç´„é•åã®è©³ç´°åˆ†æ
            assigned_lessons = [l for l in solution.lessons if l.timeslot and l.room]
            print(f"ğŸ“Š Assigned: {len(assigned_lessons)}/{len(solution.lessons)} lessons")
            
            return solution
            
        except Exception as e:
            print(f"âŒ Optimization Error: {e}")
            import traceback
            traceback.print_exc()
            raise e
"""TimefoldAI Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"""
from flask import Flask, render_template
from flask_cors import CORS
import logging

def create_app(config=None):
    """Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¯ãƒˆãƒª"""
    app = Flask(__name__, 
                static_folder='../frontend/static',
                template_folder='../frontend/templates')
    
    # CORSè¨­å®šï¼ˆé–‹ç™ºç”¨ï¼‰
    CORS(app)
    
    # ãƒ­ã‚°è¨­å®š
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    # è¨­å®š
    if config:
        app.config.update(config)
    else:
        app.config.update({
            'DEBUG': True,
            'HOST': 'localhost',
            'PORT': 8000
        })
    
    # Blueprintç™»éŒ²
    try:
        from backend.api.routes import api_bp
        app.register_blueprint(api_bp, url_prefix='/api')
        logger.info("âœ… API Blueprint ç™»éŒ²æˆåŠŸ")
        
        # ç™»éŒ²ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆèµ·å‹•æ™‚ï¼‰
        for rule in app.url_map.iter_rules():
            logger.info(f"ğŸ“ ç™»éŒ²ãƒ«ãƒ¼ãƒˆ: {rule.endpoint} -> {rule.rule}")
            
    except Exception as e:
        logger.error(f"âŒ API Blueprint ç™»éŒ²å¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
    
    try:
        from backend.api.customize_routes import customize_bp
        app.register_blueprint(customize_bp)  # ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºAPIè¿½åŠ 
        logger.info("âœ… Customize Blueprint ç™»éŒ²æˆåŠŸ")
    except Exception as e:
        logger.warning(f"âš ï¸ Customize Blueprint ç™»éŒ²å¤±æ•— (ã‚¹ã‚­ãƒƒãƒ—): {e}")
    
    @app.route('/')
    def index():
        """ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸"""
        return render_template('index.html')
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã®è¿½åŠ ãƒ«ãƒ¼ãƒˆï¼ˆå¿µã®ãŸã‚ï¼‰
    @app.route('/health')
    def health():
        return {"status": "ok", "message": "App is running"}
    
    @app.errorhandler(404)
    def not_found(error):
        return {"error": "Not Found"}, 404
    
    @app.errorhandler(500)
    def internal_error(error):
        return {"error": "Internal Server Error"}, 500
    
    return app

if __name__ == '__main__':
    app = create_app()
    app.run(
        host=app.config['HOST'],
        port=app.config['PORT'],
        debug=app.config['DEBUG']
    )
"""ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼"""
from abc import ABC, abstractmethod
from typing import List, Optional, Dict, Any
import json
import os
from .data_models import Subject, Teacher, TimeSlot, StudentGroup, Lesson

class DataRepository(ABC):
    """ãƒ‡ãƒ¼ã‚¿ãƒªãƒã‚¸ãƒˆãƒªã®æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹"""
    
    @abstractmethod
    def get_subjects(self) -> List[Subject]:
        pass
    
    @abstractmethod
    def get_teachers(self) -> List[Teacher]:
        pass
    
    @abstractmethod
    def get_timeslots(self) -> List[TimeSlot]:
        pass
    
    @abstractmethod
    def get_student_groups(self) -> List[StudentGroup]:
        pass
    
    @abstractmethod
    def save_subject(self, subject: Subject) -> Subject:
        pass
    
    @abstractmethod
    def save_teacher(self, teacher: Teacher) -> Teacher:
        pass

class JSONDataRepository(DataRepository):
    """JSONãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒªãƒã‚¸ãƒˆãƒª"""
    
    def __init__(self, data_dir: str = "backend/data"):
        self.data_dir = data_dir
        self.ensure_data_dir()
        self._subjects = []
        self._teachers = []
        self._timeslots = []
        self._student_groups = []
        self.load_all_data()
    
    def ensure_data_dir(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºä¿"""
        os.makedirs(self.data_dir, exist_ok=True)
    
    def load_all_data(self):
        """å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿"""
        self._subjects = self._load_subjects()
        self._teachers = self._load_teachers()
        self._timeslots = self._load_timeslots()
        self._student_groups = self._load_student_groups()
    
    def _load_subjects(self) -> List[Subject]:
        """ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿"""
        file_path = os.path.join(self.data_dir, "subjects.json")
        if not os.path.exists(file_path):
            return []
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                return [Subject(**item) for item in data]
        except Exception as e:
            print(f"ç§‘ç›®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def _load_teachers(self) -> List[Teacher]:
        """æ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿"""
        file_path = os.path.join(self.data_dir, "teachers.json")
        if not os.path.exists(file_path):
            return []
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                return [Teacher(**item) for item in data]
        except Exception as e:
            print(f"æ•™å¸«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def _load_timeslots(self) -> List[TimeSlot]:
        """æ™‚é–“æ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”Ÿæˆï¼‰"""
        default_timeslots = []
        days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"]
        times = [
            ("09:00", "09:50", "1é™"),
            ("10:00", "10:50", "2é™"),
            ("11:00", "11:50", "3é™"),
            ("13:00", "13:50", "4é™"),
            ("14:00", "14:50", "5é™"),
            ("15:00", "15:50", "6é™")
        ]
        
        slot_id = 1
        for day in days:
            for start_time, end_time, period in times:
                timeslot = TimeSlot(
                    id=slot_id,
                    day_of_week=day,
                    start_time=start_time,
                    end_time=end_time,
                    period_name=period,
                    duration_minutes=50
                )
                default_timeslots.append(timeslot)
                slot_id += 1
        
        return default_timeslots
    
    def _load_student_groups(self) -> List[StudentGroup]:
        """å­¦ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”Ÿæˆï¼‰"""
        return [
            StudentGroup(
                id=1,
                name="1å¹´Açµ„",
                grade=1,
                class_letter="A", 
                student_count=30,
                curriculum=["æ•°å­¦", "å›½èª", "è‹±èª"]
            )
        ]
    
    def _save_subjects(self, subjects: List[Subject]):
        """ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜"""
        file_path = os.path.join(self.data_dir, "subjects.json")
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump([s.to_dict() for s in subjects], f, ensure_ascii=False, indent=2)
        print(f"ğŸ“š ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: {len(subjects)}ä»¶")
    
    def _save_teachers(self, teachers: List[Teacher]):
        """æ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜"""
        file_path = os.path.join(self.data_dir, "teachers.json")
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump([t.to_dict() for t in teachers], f, ensure_ascii=False, indent=2)
        print(f"ğŸ‘¨â€ğŸ« æ•™å¸«ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: {len(teachers)}ä»¶")
    
    # æŠ½è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
    def get_subjects(self) -> List[Subject]:
        return self._subjects.copy()
    
    def get_teachers(self) -> List[Teacher]:
        return self._teachers.copy()
    
    def get_timeslots(self) -> List[TimeSlot]:
        return self._timeslots.copy()
    
    def get_student_groups(self) -> List[StudentGroup]:
        return self._student_groups.copy()
    
    def save_subject(self, subject: Subject) -> Subject:
        # æ—¢å­˜ã®ç§‘ç›®ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦è¿½åŠ 
        found = False
        for i, s in enumerate(self._subjects):
            if s.id == subject.id:
                self._subjects[i] = subject
                found = True
                break
        
        if not found:
            self._subjects.append(subject)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        self._save_subjects(self._subjects)
        print(f"âœ… ç§‘ç›®ä¿å­˜: {subject.name} (ID: {subject.id})")
        return subject
    
    def save_teacher(self, teacher: Teacher) -> Teacher:
        # æ—¢å­˜ã®æ•™å¸«ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦è¿½åŠ 
        found = False
        for i, t in enumerate(self._teachers):
            if t.id == teacher.id:
                self._teachers[i] = teacher
                found = True
                break
        
        if not found:
            self._teachers.append(teacher)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        self._save_teachers(self._teachers)
        print(f"âœ… æ•™å¸«ä¿å­˜: {teacher.name} (ID: {teacher.id})")
        return teacher
    
    def delete_subject(self, subject_id: int) -> bool:
        """ç§‘ç›®ã‚’å‰Šé™¤"""
        original_count = len(self._subjects)
        self._subjects = [s for s in self._subjects if s.id != subject_id]
        
        if len(self._subjects) < original_count:
            self._save_subjects(self._subjects)
            print(f"ğŸ—‘ï¸ ç§‘ç›®å‰Šé™¤: ID {subject_id}")
            return True
        return False
    
    def delete_teacher(self, teacher_id: int) -> bool:
        """æ•™å¸«ã‚’å‰Šé™¤"""
        original_count = len(self._teachers)
        self._teachers = [t for t in self._teachers if t.id != teacher_id]
        
        if len(self._teachers) < original_count:
            self._save_teachers(self._teachers)
            print(f"ğŸ—‘ï¸ æ•™å¸«å‰Šé™¤: ID {teacher_id}")
            return True
        return False
    
    def generate_lessons(self) -> List[Lesson]:
        """æˆæ¥­ãƒªã‚¹ãƒˆã®ç”Ÿæˆ"""
        lessons = []
        lesson_id = 1
        
        subjects = self.get_subjects()
        teachers = self.get_teachers()
        student_groups = self.get_student_groups()
        
        for student_group in student_groups:
            for subject in subjects:
                teacher = self._find_teacher_for_subject(teachers, subject.name)
                if teacher:
                    lesson = Lesson(
                        id=lesson_id,
                        subject=subject,
                        teacher=teacher,
                        student_group=student_group,
                        lesson_type="regular"
                    )
                    lessons.append(lesson)
                    lesson_id += 1
        
        return lessons
    
    def _find_teacher_for_subject(self, teachers: List[Teacher], subject_name: str) -> Optional[Teacher]:
        """ç§‘ç›®ã«å¯¾å¿œã™ã‚‹æ•™å¸«ã‚’æ¤œç´¢"""
        for teacher in teachers:
            if subject_name in teacher.subjects:
                return teacher
        return None
